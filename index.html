<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NC Crime Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.0/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">

<style>
html, body, #map { width: 100%; height: 100%; margin: 0; background: #fff; font-family: 'Titillium Web', sans-serif; }
.legend { line-height: 22px; font-size: 14px; width: 260px; color: #333; padding: 8px; background: rgba(255,255,255,0.95); box-shadow: 0 0 15px rgba(0,0,0,0.15); border-radius: 6px; }
.legend i { width:20px; height:20px; float:left; margin-right:8px; opacity:.95; border-radius:3px; }
.legend p { font-size:13px; margin: 3px 0; }
.crime-icon-1 { color:#ff0000; font-size:22px; text-shadow:0 0 3px #fff; }
.crime-icon-2 { color:#800080; font-size:22px; text-shadow:0 0 3px #fff; }
.crime-icon-3 { color:#ff8c00; font-size:22px; text-shadow:0 0 3px #fff; }
.crime-icon-4 { color:#0077ff; font-size:22px; text-shadow:0 0 3px #fff; }
</style>

<script src="https://unpkg.com/leaflet@1.7.0/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
</head>
<body>
<div id="map"></div>
<script>
function getValue(props, fields){
    for (let key of fields) {
        if (props[key] !== undefined && props[key] !== null) {
            let num = Number(props[key]);
            return isNaN(num) ? props[key] : num;
        }
    }
    return 0;
}

var mymap = L.map('map', {center:[35.5,-79.5], zoom:7, minZoom:6, maxZoom:18, detectRetina:true});
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(mymap);

var polycolors = chroma.scale('Purples').colors(10);
var countyCrimeTotals = {};

$.getJSON("crimes.geojson", function(data){
    data.features.forEach(function(f){
        let props = f.properties;
        let countyName = props.County || props.county || props.Name || props.name || "Unknown";
        let violent = getValue(props, ["Murder","Rape","Robbery","Aggravated Assault"]);
        if(!countyCrimeTotals[countyName]) countyCrimeTotals[countyName] = 0;
        countyCrimeTotals[countyName] += violent;
    });

    L.geoJson.ajax("muni.geojson", {
        style: function(feature){
            let name = getValue(feature.properties, ["name","NAME","county","County"]) || "Unknown";
            let total = countyCrimeTotals[name] || 0;
            return {fillColor:setColor(total), fillOpacity:0.7, color:"#666", weight:1.5, dashArray:"2"};
        },
        onEachFeature: function(feature, layer){
            let name = getValue(feature.properties, ["name","NAME","county","County"]) || "Unknown";
            let total = countyCrimeTotals[name] || 0;
            layer.bindPopup("<b>County:</b> " + name + "<br><b>Total Violent Crime:</b> " + total);
        }
    }).addTo(mymap);
});

function setColor(d){
    if(d>500) return polycolors[9];
    if(d>400) return polycolors[8];
    if(d>350) return polycolors[7];
    if(d>300) return polycolors[6];
    if(d>250) return polycolors[5];
    if(d>200) return polycolors[4];
    if(d>150) return polycolors[3];
    if(d>100) return polycolors[2];
    if(d>50) return polycolors[1];
    return polycolors[0];
}

L.geoJson.ajax("crimes.geojson", {
    onEachFeature: function(feature, layer){
        let p = feature.properties || {};
        let city = getValue(p, ["City","city","NAME","name"]) || "City";
        let pop = getValue(p, ["Population","population","POP","pop"]);
        let murder = getValue(p, ["Murder"]) || 0;
        let rape = getValue(p, ["Rape"]) || 0;
        let robbery = getValue(p, ["Robbery"]) || 0;
        let assault = getValue(p, ["Aggravated Assault"]) || 0;
        layer.bindPopup("<b>City:</b> " + city + "<br><b>Population:</b> " + pop +
            "<br><b>Violent Crime Breakdown:</b><br>Murder: "+murder+"<br>Rape: "+rape+"<br>Robbery: "+robbery+"<br>Aggravated Assault: "+assault);
    },
    pointToLayer: function(feature, latlng){
        let p = feature.properties || {};
        let murder = Number(getValue(p, ["Murder"])) || 0;
        let rape = Number(getValue(p, ["Rape"])) || 0;
        let robbery = Number(getValue(p, ["Robbery"])) || 0;
        let assault = Number(getValue(p, ["Aggravated Assault"])) || 0;
        let iconClass = "";
        if(murder>0) iconClass = "fa-solid fa-skull-crossbones crime-icon-1";
        else if(rape>0) iconClass = "fa-solid fa-handcuffs crime-icon-2";
        else if(robbery>0) iconClass = "fa-solid fa-mask crime-icon-3";
        else if(assault>0) iconClass = "fa-solid fa-fist-raised crime-icon-4";
        else iconClass = "fa-solid fa-circle crime-icon-4";
        return L.marker(latlng, {icon:L.divIcon({html:'<i class="'+iconClass+'"></i>', className:'', iconSize:[26,26]})});
    }
}).addTo(mymap);

var legend = L.control({position:'topright'});
legend.onAdd = function() {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML += "<b>Total Violent Crime per County</b><br>";
    for(let i=9;i>=0;i--) div.innerHTML += "<i style='background:"+polycolors[i]+"'></i><p></p>";
    div.innerHTML += "<hr><b>Violent Crime Type</b><br>";
    div.innerHTML += "<i class='fa-solid fa-skull-crossbones crime-icon-1'></i><p>Murder</p>";
    div.innerHTML += "<i class='fa-solid fa-handcuffs crime-icon-2'></i><p>Rape</p>";
    div.innerHTML += "<i class='fa-solid fa-mask crime-icon-3'></i><p>Robbery</p>";
    div.innerHTML += "<i class='fa-solid fa-fist-raised crime-icon-4'></i><p>Aggravated Assault</p>";
    return div;
};
legend.addTo(mymap);
L.control.scale({position:'bottomleft'}).addTo(mymap);
</script>
</body>
</html>




